<!DOCTYPE html>
<html>
    <head>
        <title>JavaScript, jQuery and DOM Ready in Drupal 7 &mdash; À moi la garde ! &mdash; </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="http://pbuyle.github.io/css/solarized-light-bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="http://pbuyle.github.io/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="http://pbuyle.github.io/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="http://pbuyle.github.io/components/highlightjs/styles/solarized_dark.css" />
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
    </head>
    <body>
        <header>

            <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://pbuyle.github.io/">À moi la garde !</a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="http://pbuyle.github.io/blog">Archives</a></li>
                        <li><a href="http://pbuyle.github.io/blog/tags">Tags</a></li>
                    </ul>
                </div><!-- /.navbar-collapse -->
            </nav>
        </header>
        <div class="mainContent container">
            <div class="col-md-12">
                    <article>
        <header class="page-header">
            <h1>JavaScript, jQuery and DOM Ready in Drupal 7 <small><span class="glyphicon glyphicon-file"></span>post</small></h1>
        </header>

                <p class="pull-right tags">
            <span class="glyphicon glyphicon-tags"></span>&nbsp;
                        <a href="http://pbuyle.github.io/blog/tags/drupal">drupal</a>,                         <a href="http://pbuyle.github.io/blog/tags/drupal-7">drupal-7</a>,                         <a href="http://pbuyle.github.io/blog/tags/javascript">javascript</a>,                         <a href="http://pbuyle.github.io/blog/tags/jquery">jquery</a>                    </p>
        
        <div>
            <p><strong>tl;dr</strong>: JavaScript code to process elements on page load on a Drupal 7 site should looks like this:</p>

<pre><code class="javascript">(function($) {
  Drupal.behaviors.doSomething = {
    attach: function(context, settings) {
      $('div.something', context).once('do-something').doSomething({
        param1: settings.somethingl.param,
        param2: 'something else'
      });
    }
  }
})(jQuery);
</code></pre>

<p>Drupal 7 provides jQuery in the <a href="http://api.jquery.com/jQuery.noConflict/">no-conflict mode</a>, which means that <code>$</code> is
not the jQuery object/namespace. This should not be an issue with properly written jQuery plugins that follow
<a href="http://docs.jquery.com/Plugins/Authoring">jQuery's plugins authoring guidelines</a>. This is however an issue for code
snippets mindlessly copy/pasted from random web pages. Most of them expect <code>$</code> to be the jQuery namespace and will not
work within a Drupal page. This can be easily solved by wrapping theses snippets in immediately invoked anonymous
function that will alias the jQuery namespace to <code>$</code>:</p>

<pre><code class="javascript">(function($) {
    // Here $ is the jQuery namespace.
})(jQuery);
</code></pre>

<p>Usually, JavaScript code that needs to run at page load, is also wrapped in a function passed as argument to <code>jQuery()</code>
or <code>jQuery(document).ready()</code>:</p>

<pre><code class="javascript">$(function() {
  // Code here is executed when the DOM is loaded.
});
</code></pre>

<p>When combined, these two patterns are perfectly fine, even within Drupal. However if content (ie. new DOM elements) is
added to the page after page load (AJAX calls, content generated from JavaScript, etc.) the code in such functions will
never be able to process the added elements. Or if some portion of the content is removed or moved across the page, the
code will have no option to unregistered event handlers or update information about the already processed elements.
Drupal provides an API for this called <a href="http://drupal.org/node/756722#behaviors">behaviors</a>. Using behavior is not
required, but strongly recommended as a best practice to avoid future headaches (when code written six months ago starts
behaving strangely when a contrib module is added to the project). A behavior is written like this:</p>

<pre><code class="javascript">Drupal.behaviors.behaviorName = {
  attach: function (context, settings) {
    // Do something.
  },
  detach: function (context, settings, trigger) {
    // Undo something.
  }
};
</code></pre>

<p>The <code>attach</code> function of all registered behaviors (all properties of the <code>Drupal.behaviors</code> object) will be invoked
when behavior should be added to elements, either when the DOM is ready (ie. page load) and when elements are added to
the DOM. The <code>detach</code> function will be called when behaviors should be detached from elements: just before elements
are removed from the DOM, moved in the DOM or a form is submitted. The <code>context</code> parameter will always be a parent of
the added elements, the single added/removed/moved/submitted element itself or the whole <code>document</code> element. The
<code>settings</code> parameters will be the settings for the <code>context</code>, usually the <code>Drupal.settings</code> object as set by calls
to <a href="http://api.drupal.org/api/drupal/includes!common.inc/function/drupal_add_js/7"><code>drupal_add_js()</code></a> from PHP. For
<code>detach</code>, the <code>trigger</code> parameter will contains the kind of event that triggered the call: <code>'unload'</code> (elements
removed), <code>'move'</code> (elements moved) or <code>'serialize'</code> (form is being submitted).</p>

<p>The <code>attach</code> (and <code>detach</code>) functions of a behavior can be used multiple time over the same portion of the DOM tree.
So the same element could be processed multiple time by the same code. It is up to the code itself to avoid processing
(ie. binding event handlers, altering CSS styles, etc.) multiple times for the same elements. The easiest solution for
this is to use the <a href="http://plugins.jquery.com/once/">jQuery Once</a> plugin (which
<a href="http://drupal.org/node/756722#jquery-once">is provided by Drupal 7</a>) like this:</p>

<pre><code class="javascript">$(selector).once('behavior-name').doSomething();
$(selector).once('behavior-name', function(){ /*do something*/ });
</code></pre>

<p>Since a behavior is being attached/detached to/from a context, the context object can be used to restrict your jQuery
queries to only the affected element or DOM subtree, like this:</p>

<pre><code class="javascript">$(selector, context).doSomething();
</code></pre>

<p>Putting all this together means the base pattern to process elements on page load should looks like this:</p>

<pre><code class="javascript">(function($) {
  Drupal.behaviors.doSomething = {
    attach: function(context, settings) {
      $('div.something', context).once('do-something').doSomething({
        param1: settings.somethingl.param,
        param2: 'something else'
      });
    }
  }
})(jQuery);
</code></pre>

<p>References:</p>

<ul>
<li><a href="http://drupal.org/node/756722">Managing JavaScript in Drupal 7</a></li>
<li><a href="http://drupal.org/update/modules/6/7#drupal_behaviors">Converting 6.x modules to 7.x - Changed Drupal.behaviors to objects having the properties 'attach' and 'detach'</a></li>
<li><a href="http://api.drupal.org/api/drupal/includes!common.inc/function/drupal_add_js/7">http://api.drupal.org/api/drupal/includes!common.inc/function/drupal_add_js/7</a></li>
<li><a href="http://plugins.jquery.com/once/">jQuery Once</a></li>
</ul>

        </div>
    </article>
            </div>
        </div>
        <footer class="container">
            <div class="col-md-9">Powered by <a href="https://sculpin.io">Sculpin</a> - Hosted on <a href="http://pages.github.com/">Github</a> - &copy; <a href="http://about.me/pbuyle">Pierre Buyle</a></small></div>
            <div class="col-md-3"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br />Except where otherwise noted, content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a></div>.
        </footer>

        <script src="http://pbuyle.github.io/components/jquery/jquery.min.js"></script>
        <script src="http://pbuyle.github.io/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-291684-6', 'auto');
            ga('send', 'pageview');
        </script>
                <script src="http://pbuyle.github.io/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
                <!-- AddThis Smart Layers BEGIN -->
        <!-- Go to http://www.addthis.com/get/smart-layers to customize -->
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=mongolito404"></script>
        <script type="text/javascript">
            addthis.layers({
                'theme' : 'transparent',
                'share' : {
                    'position' : 'left',
                    'numPreferredServices' : 5
                },
                'thankyou' : false
            });
        </script>
        <!-- AddThis Smart Layers END -->
            </body>
</html>
